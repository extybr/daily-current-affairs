Инструкция по QEMU

Основные компоненты

1. qemu-system-x86_64 (эмуляция системы)
    qemu-system-x86_64 [опции]

2. qemu-img (работа с образами дисков)
    qemu-img [команда] [опции]

3. qemu-kvm (аппаратная виртуализация через KVM)
    qemu-kvm [опции]

qemu-img - управление дисковыми образами

Форматы образов:
    qemu-img create -f qcow2 disk.qcow2 10G        # qcow2 (рекомендуется)
    qemu-img create -f raw disk.raw 10G            # raw
    qemu-img create -f vdi disk.vdi 10G            # VirtualBox VDI
    qemu-img create -f vmdk disk.vmdk 10G          # VMware VMDK
    qemu-img create -f vpc disk.vhd 10G            # Hyper-V VHD

Команды qemu-img:
    # Создание образа
    qemu-img create -f формат файл размер

    # Информация об образе
    qemu-img info образ.qcow2

    # Конвертация форматов
    qemu-img convert -f исходный_формат -O целевой_формат вход выход

    # Изменение размера
    qemu-img resize образ.qcow2 +5G
    qemu-img resize образ.qcow2 20G

    # Создание снимка (снэпшот)
    qemu-img snapshot -c имя_снимка образ.qcow2

    # Список снимков
    qemu-img snapshot -l образ.qcow2

    # Восстановление снимка
    qemu-img snapshot -a имя_снимка образ.qcow2

    # Удаление снимка
    qemu-img snapshot -d имя_снимка образ.qcow2

    # Проверка целостности
    qemu-img check образ.qcow2

    # Сравнение образов
    qemu-img compare образ1.qcow2 образ2.qcow2

    # Изменение backing файла
    qemu-img rebase -b новый_базовый_файл образ.qcow2

Примеры qemu-img:
    # Создать qcow2 диск 20GB
    qemu-img create -f qcow2 ubuntu.qcow2 20G

    # Конвертировать raw в qcow2
    qemu-img convert -f raw -O qcow2 disk.raw disk.qcow2

    # Увеличить диск на 10GB
    qemu-img resize ubuntu.qcow2 +10G

    # Создать цепочку снимков
    qemu-img create -f qcow2 -b базовый.qcow2 снимок.qcow2

qemu-system-x86_64 - запуск виртуальных машин

Базовые опции:
    # Минимальный запуск
    qemu-system-x86_64 -m 2G -hda disk.qcow2

    # С указанием образа ISO для установки
    qemu-system-x86_64 -m 4G -cdrom ubuntu.iso -hda disk.qcow2

    # С несколькими дисками
    qemu-system-x86_64 -m 4G \
      -drive file=system.qcow2,format=qcow2 \
      -drive file=data.raw,format=raw

Управление памятью:
    -m 2G                    # 2GB RAM
    -m 4G -smp 4            # 4GB RAM, 4 CPU
    -m 1G -mem-prealloc     # предварительное выделение памяти

CPU и SMP:
    -cpu host               # использовать CPU хоста
    -cpu qemu64             # эмулировать qemu64 CPU
    -cpu IvyBridge          # конкретная модель CPU
    -smp 4                  # 4 CPU ядра
    -smp 8,sockets=2,cores=4,threads=1  # сложная топология

Сетевые настройки:
    -net nic                # добавить сетевую карту
    -net user               # пользовательский режим сети (NAT)
    -net bridge             # мостовой режим
    -net tap                # TAP интерфейс

    # Пользовательская сеть (по умолчанию)
    -netdev user,id=net0 -device e1000,netdev=net0

    # TAP сеть (требуются права)
    -netdev tap,id=net0,ifname=tap0 -device virtio-net-pci,netdev=net0

    # Проброс портов
    -net user,hostfwd=tcp::2222-:22  # проброс SSH порта

Устройства ввода/вывода:
    # Графика
    -vga std                # стандартная VGA
    -vga virtio             # virtio VGA
    -nographic              # без графики (только консоль)
    -display sdl            # SDL дисплей
    -display gtk            # GTK дисплей
    -display vnc=:1         # VNC на порту 5901

    # Звук
    -soundhw ac97           # AC97 звуковая карта
    -soundhw hda            # Intel HD Audio
    -audiodev pa,id=audio0  # PulseAudio вывод

    # USB
    -usb                    # включить USB
    -device usb-tablet      # USB таблетка для точного курсора
    -device usb-mouse       # USB мышь
    -device usb-kbd         # USB клавиатура

Ускорение KVM:
    -enable-kvm             # включить KVM (требует аппаратной поддержки)
    -accel kvm              # ускорение через KVM
    -machine accel=kvm      # машина с KVM

Загрузочные опции:
    -boot order=dc          # порядок загрузки: d=disk, c=cdrom, n=network
    -boot menu=on           # показать меню загрузки
    -bios /usr/share/qemu/bios.bin  # указать BIOS
    -uefi                   # использовать UEFI

Монитор QEMU:
    -monitor stdio          # монитор в stdio
    -monitor telnet:127.0.0.1:4444,server,nowait  # telnet монитор
    -monitor vc             # виртуальная консоль

Примеры запуска:

1. Базовая установка Linux:
    qemu-system-x86_64 \
      -m 4G \
      -smp 4 \
      -hda ubuntu.qcow2 \
      -cdrom ubuntu-22.04.iso \
      -boot order=dc \
      -vga virtio \
      -display gtk

2. Виртуальная машина с Windows:
    qemu-system-x86_64 \
      -enable-kvm \
      -m 8G \
      -smp 8 \
      -cpu host \
      -drive file=windows.qcow2,format=qcow2 \
      -drive file=windows.iso,media=cdrom \
      -vga qxl \
      -usb \
      -device usb-tablet \
      -net nic,model=virtio \
      -net user,hostfwd=tcp::3389-:3389

3. Сервер без графики:
    qemu-system-x86_64 \
      -enable-kvm \
      -m 2G \
      -smp 2 \
      -drive file=server.qcow2,format=qcow2 \
      -nographic \
      -serial mon:stdio \
      -net nic,model=virtio \
      -net user,hostfwd=tcp::2222-:22

4. Сеть с пробросом портов:
    qemu-system-x86_64 \
      -m 2G \
      -hda vm.qcow2 \
      -net nic \
      -net user,hostfwd=tcp::2222-:22,hostfwd=tcp::8080-:80

Управление во время работы

Комбинации клавиш:
    Ctrl+Alt+F    - полноэкранный режим
    Ctrl+Alt+G    - выйти из захвата мыши
    Ctrl+Alt+2    - перейти в монитор QEMU
    Ctrl+Alt+1    - вернуться в VM
    Ctrl+Alt++    - увеличить экран
    Ctrl+Alt+-    - уменьшить экран

Команды монитора QEMU (после Ctrl+Alt+2):
    help                    # список команд
    info status             # статус VM
    info block              # информация о дисках
    info network            # сетевые устройства
    info snapshots          # список снимков
    savevm имя              # создать снимок
    loadvm имя              # загрузить снимок
    delvm имя               # удалить снимок
    screendump файл.ppm     # скриншот
    quit                    # выйти из QEMU
    system_reset            # перезагрузить VM
    system_powerdown        # выключить VM
    migrate uri             # миграция
    device_add driver       # добавить устройство
    device_del id           # удалить устройство

Специализированные варианты

qemu-system-i386 (32-bit):
    qemu-system-i386 -m 1G -hda dos.img

qemu-system-aarch64 (ARM64):
    qemu-system-aarch64 \
      -M virt \
      -cpu cortex-a57 \
      -m 2G \
      -kernel Image \
      -initrd initrd.img \
      -append "root=/dev/vda"

qemu-system-ppc64 (PowerPC):
    qemu-system-ppc64 \
      -M pseries \
      -m 4G \
      -hda ppc.qcow2

Расширенные возможности

1. VirtIO устройства (для производительности):
    -drive file=disk.qcow2,if=virtio,format=qcow2
    -netdev user,id=net0 -device virtio-net-pci,netdev=net0
    -device virtio-balloon-pci  # balloon драйвер памяти
    -device virtio-rng-pci      # генератор случайных чисел
    -device virtio-scsi-pci     # SCSI контроллер

2. SPICE протокол (удаленный доступ):
    -spice port=5900,addr=127.0.0.1,disable-ticketing \
    -device virtio-serial-pci \
    -chardev spicevmc,id=vdagent,name=vdagent \
    -device virtserialport,chardev=vdagent,name=com.redhat.spice.0

3. 9p файловая система (расшаренные папки):
    -fsdev local,security_model=mapped,id=fsdev0,path=/путь/на/хосте \
    -device virtio-9p-pci,fsdev=fsdev0,mount_tag=hostshare

В гостевой системе:
    mount -t 9p hostshare /mnt -o trans=virtio

4. PCI passthrough:
    -device vfio-pci,host=01:00.0  # проброс PCI устройства

Практические примеры

1. Создание и запуск VM с нуля:
    # Создать диск
    qemu-img create -f qcow2 ubuntu-vm.qcow2 20G

    # Запустить установку
    qemu-system-x86_64 \
      -enable-kvm \
      -m 4G \
      -smp 4 \
      -hda ubuntu-vm.qcow2 \
      -cdrom ubuntu-22.04-live-server-amd64.iso \
      -boot order=dc \
      -vga virtio \
      -display gtk

2. Запуск существующей VM:
    qemu-system-x86_64 \
      -enable-kvm \
      -m 4G \
      -smp 4 \
      -hda /var/lib/libvirt/images/vm.qcow2 \
      -vga virtio \
      -net nic -net user,hostfwd=tcp::2222-:22 \
      -daemonize  # запустить в фоне

3. Сервер с доступом по SSH:
    qemu-system-x86_64 \
      -enable-kvm \
      -m 2G \
      -smp 2 \
      -hda server.qcow2 \
      -nographic \
      -serial mon:stdio \
      -net nic,model=virtio \
      -net user,hostfwd=tcp::10022-:22
    # Подключение: ssh -p 10022 localhost

4. Сеть с мостом (требует настройки на хосте):
    qemu-system-x86_64 \
      -enable-kvm \
      -m 4G \
      -hda vm.qcow2 \
      -netdev bridge,id=net0,br=br0 \
      -device virtio-net-pci,netdev=net0

5. Быстрый запуск для тестирования:
    qemu-system-x86_64 \
      -enable-kvm \
      -m 1G \
      -cdrom live-cd.iso \
      -boot d \
      -vnc :1 \
      -daemonize

Утилиты управления

1. qemu-ga (QEMU Guest Agent):

Устанавливается в гостевой системе для улучшенного управления.

2. qemu-nbd (Network Block Device):
    # Экспорт образа как сетевого блочного устройства
    qemu-nbd -c /dev/nbd0 disk.qcow2
    mount /dev/nbd0p1 /mnt
    # ...
    qemu-nbd -d /dev/nbd0

3. qemu-io (тестирование IO):
    qemu-io -c "read 0 512" disk.img
    qemu-io -c "write 0 512" disk.img

Советы и оптимизации

1. Всегда используйте KVM если доступно:
    if grep -E 'vmx|svm' /proc/cpuinfo; then
        echo "KVM доступен"
        ACCEL="-enable-kvm"
    else
        ACCEL=""
    fi

2. Используйте формат qcow2:
        Поддержка снимков
        Динамическое выделение
        Сжатие
        Шифрование

3. VirtIO для производительности:
        if=virtio для дисков
        model=virtio для сети

4. Для серверов используйте -daemonize и -nographic

5. Мониторинг ресурсов:
    # В мониторе QEMU
    info status
    info balloon
    info cpus

Установка

Debian/Ubuntu:
    sudo apt install qemu-system qemu-utils qemu-kvm

RHEL/CentOS/Fedora:
    sudo yum install qemu-kvm qemu-img virt-manager

Arch Linux:
    sudo pacman -S qemu-full

macOS:
    brew install qemu

Отладка
    # Подробный вывод
    qemu-system-x86_64 -d help  # список отладочных опций
    qemu-system-x86_64 -d cpu_reset,guest_errors

    # Логи
    qemu-system-x86_64 -D qemu.log

    # Отладка через GDB
    qemu-system-x86_64 -s -S  # слушать на порту 1234
    gdb -ex 'target remote localhost:1234'

Эта инструкция покрывает основные сценарии использования QEMU для
создания и управления виртуальными машинами.
